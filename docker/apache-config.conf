# Apache + Passenger Configuration
# Simulates Domainesia cPanel + Passenger environment

<VirtualHost *:80>
    ServerName localhost
    ServerAdmin admin@localhost

    # Document root points to public directory (cPanel style)
    DocumentRoot /var/www/student-space/public

    # Passenger Configuration
    PassengerEnabled on
    PassengerAppRoot /var/www/student-space
    PassengerPython /var/www/venv/bin/python3.12
    PassengerStartupFile passenger_wsgi.py
    PassengerAppEnv production

    # Passenger tuning (similar to shared hosting limits)
    PassengerMaxPoolSize 6
    PassengerMinInstances 1
    PassengerMaxRequests 1000
    PassengerMaxRequestQueueSize 100
    PassengerHighPerformance on
    PassengerSpawnMethod smart

    # Static files - Django static
    Alias /static /var/www/student-space/staticfiles
    <Directory /var/www/student-space/staticfiles>
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None

        # Cache static files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>

        # Compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/css text/javascript application/javascript
        </IfModule>
    </Directory>

    # Media files - User uploads
    Alias /media /var/www/student-space/media
    <Directory /var/www/student-space/media>
        Require all granted
        Options -Indexes +FollowSymLinks
        AllowOverride None
    </Directory>

    # Public directory (for passenger_wsgi.py accessibility)
    <Directory /var/www/student-space/public>
        Require all granted
        AllowOverride All
        Options -MultiViews +FollowSymLinks
    </Directory>

    # Application root directory
    <Directory /var/www/student-space>
        Require all granted
        AllowOverride All
        Options -MultiViews

        # Process .htaccess if exists
        <IfModule mod_rewrite.c>
            RewriteEngine On
        </IfModule>
    </Directory>

    # Security headers
    <IfModule mod_headers.c>
        # Prevent clickjacking
        Header always set X-Frame-Options "SAMEORIGIN"

        # XSS Protection
        Header always set X-XSS-Protection "1; mode=block"

        # Prevent MIME sniffing
        Header always set X-Content-Type-Options "nosniff"

        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
    </IfModule>

    # Logging (similar to cPanel structure)
    ErrorLog /var/log/apache2/student-space-error.log
    CustomLog /var/log/apache2/student-space-access.log combined

    # Log level for debugging
    LogLevel warn

    # Passenger-specific logging
    PassengerLogLevel 3
    PassengerDebugLogFile /var/log/apache2/passenger-debug.log

    # Compression for text content
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Browser caching
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/html "access plus 0 seconds"
        ExpiresByType application/json "access plus 0 seconds"
    </IfModule>
</VirtualHost>

# Enable status page for debugging
<Location /server-status>
    SetHandler server-status
    Require local
</Location>

<Location /passenger-status>
    SetHandler passenger-status
    Require local
</Location>
